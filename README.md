# Руководство разработчика по проекту

## 1. Обзор проекта

**Название программы** — это настольное приложение на базе Qt 6, предназначенное для мониторинга, управления и анализа данных, поступающих от сети удаленных датчиков.

**Основные функции:**

*   **Визуализация на карте** - отображение местоположения датчиков, участков и групп на интерактивной карте OpenStreetMap.
*   **Иерархическое представление** - управление объектами в древовидной структуре: **Группы → Участки → Датчики**.
*   **Анализ данных** - построение и анализ графиков временных рядов, спектров и кросс-корреляционных функций для данных с датчиков.
*   **Сетевое взаимодействие** - приложение функционирует как TCP-сервер на порту **45555**, принимая подключения от датчиков для получения данных в реальном времени и отправки команд управления.
*   **Загрузка данных:** Поддерживается два режима загрузки данных:
    1.  **Из директории** - парсинг текстовых файлов (`Locations.txt`, `Sensors.txt`, `Data Files/Sens_*.txt`).
    2.  **По UART** - прямая загрузка данных с устройства через последовательный порт. Не протестировано.
*   **Обработка сигналов** - включает в себя низкоуровневые C-библиотеки для цифровой обработки сигналов (БПФ, обратное БПФ, кросс-корреляция) и распаковки сжатых данных с датчиков.
*   **Хранение данных** - вся структура объектов (группы, участки, датчики и их данные) сохраняется в файле `data.json` в каталоге приложения.

## 2. Настройка окружения для сборки

Для успешной сборки и запуска проекта необходимо правильно настроить среду разработки.

| Компонент | Требование | Рекомендация |
| :--- | :--- | :--- |
| **IDE** | Qt Creator | Qt Creator 10.0 или новее |
| **Версия Qt** | Qt 6.x | Qt 6.8.2 или новее |
| **Компилятор** | MSVC 64-bit (с поддержкой C++17) | **MSVC 2022 64-bit** (требует Visual Studio 2022) |
| **Система сборки**| CMake | Версия 3.16 или новее (интегрирована в Qt Creator) |

### 2.1. Установка компилятора MSVC

Компилятор MSVC является частью **Visual Studio**. Вам необходимо установить либо саму Visual Studio, либо только инструменты для сборки.

1.  Перейдите на [страницу загрузок Visual Studio](https://visualstudio.microsoft.com/downloads/).
2.  Пролистайте вниз до раздела **"Tools for Visual Studio"** и скачайте **"Build Tools for Visual Studio 2022"**.
3.  Запустите установщик.
4.  На вкладке **"Workloads"** (`Рабочие нагрузки`) выберите **"Desktop development with C++"** (`Разработка классических приложений на C++`). Это установит необходимый компилятор и библиотеки Windows SDK.
5.  Дождитесь завершения установки.

### 2.2. Установка Qt и компонентов

1.  Скачайте **Qt Online Installer** с официального сайта Qt.
2.  При установке выберите версию Qt (например, **Qt 6.8.2**).
3.  В разделе компонентов убедитесь, что выбраны следующие модули:
    *   [x] **MSVC 2019 64-bit** или **MSVC 2022 64-bit** (в зависимости от вашей Visual Studio)
    *   [x] **CMake**
    *   [x] **Qt 6 Core**
    *   [x] **Qt GUI**
    *   [x] **Qt Widgets**
    *   [x] **Qt Network**
    *   [x] **Qt Location**
    *   [x] **Qt Positioning**
    *   [x] **Qt QML**
    *   [x] **Qt Quick Widgets**
    *   [x] **Qt Charts**
    *   [x] **Qt Core 5 Compatibility Module**
    *   [x] **Qt Serial Port**

## 3. Сборка проекта

### Шаг 1 - Открытие проекта в Qt Creator
1.  Запустите Qt Creator.
2.  Выберите **File → Open File or Project...**
3.  Найдите и выберите файл `CMakeLists.txt` в корневой папке проекта.

### Шаг 2 - Конфигурация проекта
1.  После открытия `CMakeLists.txt` Qt Creator предложит сконфигурировать проект.
2.  Убедитесь, что выбран **Kit**, который соответствует установленным вами компонентам (например, **Desktop Qt 6.8.2 MSVC2022 64bit**).
3.  Нажмите кнопку **Configure Project**.

### Шаг 3 - Сборка
1.  На левой панели выберите режим сборки **Release**.
2.  Нажмите на иконку **молотка** (Build) или выберите **Build → Build Project "LD7"**.
3.  После успешной сборки исполняемый файл `LD7.exe` будет находиться в каталоге сборки (например, `build-LD7-Desktop_Qt_6_8_2_MSVC2022_64bit-Release`).

## 4. Создание дистрибутива (Deployment)

Чтобы приложение можно было запускать на других компьютерах, необходимо собрать вместе с `.exe` все нужные ему библиотеки (`.dll`), плагины и QML-файлы. Для автоматизации этого процесса используется скрипт `DEPLOY.bat`.

### 4.1. Скрипт DEPLOY.bat

Создайте файл `DEPLOY.bat` в корневой папке с исходниками проекта и скопируйте в него следующий код.

**Важно:** Файл нужно сохранить в кодировке **ANSI** (или **Windows-1251**), чтобы избежать проблем с кириллицей в путях. В Блокноте это можно сделать через "Файл" -> "Сохранить как..." и выбрать ANSI в выпадающем списке "Кодировка".

```batch
@echo off
cls

REM Переключаем кодовую страницу на Windows-1251 для поддержки кириллицы
chcp 1251

REM --- НАСТРОЙКА ---
REM --- Убедитесь, что этот путь к Visual Studio правильный! ---
set VS_SETUP_CMD="C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"

echo Setting up Visual Studio command prompt environment...
call %VS_SETUP_CMD%

if %errorlevel% neq 0 (
    echo.
    echo ERROR: Could not run the Visual Studio setup script.
    echo Please check the path in the VS_SETUP_CMD variable inside the script.
    pause
    exit /b
)

echo.
echo Changing directory to the deployment folder...
cd /d "C:\Users\Egor\Desktop\Окна\app\app"

echo.
echo Running windeployqt...
C:\Qt\6.8.2\msvc2022_64\bin\windeployqt.exe --qmldir "C:\Users\Egor\QtProjects\LD7" LD7.exe

echo.
echo --- DEPLOYMENT FINISHED ---
pause
```

### 4.2. Как использовать скрипт
1.  **Соберите проект** в Qt Creator в конфигурации **Release**.
2.  **Убедитесь, что папка для дистрибутива существует** (`C:\Users\Egor\Desktop\Окна\app\app`) и что вы **скопировали в нее `LD7.exe`** из папки сборки.
3.  Просто **дважды кликните по файлу `DEPLOY.bat`**.

Скрипт автоматически выполнит все необходимые действия. В конце папка `app` будет содержать полностью готовое к запуску приложение.

### 4.3. Настройка и возможные изменения
Если вы измените пути установки или название проекта, вам нужно будет отредактировать пути прямо в файле `DEPLOY.bat`.

*   **`set VS_SETUP_CMD="..."`** - путь к скрипту настройки окружения Visual Studio.
    *   **Как найти:**
        1.  В меню "Пуск" найдите ярлык `x64 Native Tools Command Prompt for VS 2022`.
        2.  Нажмите правой кнопкой мыши → "Перейти к расположению файла".
        3.  В открывшейся папке снова нажмите на ярлык правой кнопкой → "Свойства".
        4.  Скопируйте путь из поля "Объект" (например, `C:\...\vcvars64.bat`).
*   **`cd /d "C:\... \app"`** - путь к папке, куда вы скопировали `.exe` и где будет создан дистрибутив.
*   **`C:\Qt\...\windeployqt.exe`** - путь к утилите Qt. Он зависит от вашей версии и пути установки Qt.
*   **`--qmldir "C:\... \LD7"`** - путь к папке с исходным кодом проекта, где лежит `MapView.qml`.

## 5. Структура проекта

| Файл / Директория | Описание |
| :--- | :--- |
| **`mainwindow.h/.cpp/.ui`** | Основное окно приложения. Содержит всю основную логику UI, управление данными, обработку событий и взаимодействие между модулями. |
| **`mapwidget.h/.cpp`** | C++ класс-обертка для `QQuickWidget`, который загружает и управляет QML-картой. |
| **`MapView.qml`** | QML-компонент, реализующий интерактивную карту на базе `QtLocation` с плагином OpenStreetMap. |
| **`tcp_server.h/.cpp`** | Реализация TCP-сервера, который слушает порт 45555 и управляет подключениями. |
| **`qclient.h/.cpp`** | Класс, представляющий подключенного клиента (датчик). Обрабатывает прием/передачу данных по кастомному протоколу (`nc_*`). |
| **`dataloader.h/.cpp`** | Класс для загрузки и парсинга данных из файловой структуры (режим "Из папки"). |
| **`uartloaddialog.h/.cpp`** | Диалоговое окно и логика для загрузки данных с устройства по UART. |
| **`data_structures.h`** | Определения основных структур данных: `GroupData`, `SiteData`, `SensorData`. |
| **`dsplib.h/.c`** | Внешняя C-библиотека для выполнения цифровой обработки сигналов (БПФ, кросс-корреляция). |
| **`CUT_pack_unpack.h/.c`** | Внешняя C-библиотека для распаковки бинарных данных, полученных от датчиков. |
| **`custommessagebox.h/.cpp`** | Пользовательский класс для стилизованных модальных и немодальных окон. |
| **`selectsitedialog.h/.cpp`** | Диалоговое окно для выбора участка при добавлении датчика. |
| **`CMakeLists.txt`** | Скрипт сборки проекта для CMake. |
| **`resources.qrc`** | Файл ресурсов Qt, содержащий иконки и QML-файл. |

## 6. Ключевые архитектурные решения

*   **Основное приложение** - `MainWindow` является центральным контроллером, который управляет состоянием UI, данными и взаимодействием с бэкенд-компонентами (сеть, загрузчики данных).
*   **Картографический модуль** - используется гибридный подход C++/QML. `MapWidget` (C++) выступает в роли моста, позволяя основной логике управлять QML-компонентом `MapView.qml` (добавлять маркеры, центрировать карту и т.д.). Это обеспечивает гибкость QML для визуализации и мощь C++ для управления.
*   **Сетевое взаимодействие** - приложение запускает `tcpsrv` (наследник `QTcpServer`), который для каждого нового подключения создает объект `QClient` (наследник `QObject` с `QTcpSocket`). Такой подход позволяет асинхронно обрабатывать множество подключений, хотя в текущей реализации `MainWindow` работает только с одним активным `Client`.
*   **Загрузка данных:**
    *   `DataLoader` - отвечает за парсинг текстовых файлов. Важная деталь - файлы должны быть в кодировке **Windows-1251**.
    *   `UartLoadDialog` - инкапсулирует всю работу с `QSerialPort`, предоставляя простой интерфейс для получения данных через UART.
*   **Обработка сигналов (DSP)** - функции БПФ, кросс-корреляции и распаковки вынесены в отдельные C-файлы (`dsplib.c`, `CUT_unpack.c`). Это сделано для максимальной производительности и переносимости этого критически важного кода.
*   **Хранение данных** - состояние приложения (все группы, участки, датчики и их записи) сериализуется в JSON-файл `data.json`. Это обеспечивает простоту чтения и отладки, а также персистентность данных между запусками.

## 7. Возможные проблемы и их решения

*   **Проблема** - проект не собирается, CMake жалуется на отсутствующие компоненты Qt.
    *   **Решение** - убедитесь, что все модули, перечисленные в пункте **2.2**, установлены для вашей версии Qt. Запустите **Qt Maintenance Tool** и доустановите недостающие компоненты.

*   **Проблема** - Qt Creator не находит компилятор MSVC.
    *   **Решение** - убедитесь, что вы установили **"Build Tools for Visual Studio"** с рабочей нагрузкой **"Desktop development with C++"**, как описано в пункте **2.1**. После установки перезапустите Qt Creator. Он должен автоматически обнаружить компилятор.

*   **Проблема** - карта в приложении не отображается (белый или серый экран).
    *   **Решение** - проверьте подключение к Интернету, так как тайлы для OpenStreetMap загружаются из сети. Также убедитесь, что модули `Qt Location` и `Qt Positioning` установлены корректно.

*   **Проблема** - при загрузке данных "Из папки" текст в приложении отображается некорректно (кракозябры).
    *   **Решение** - файлы `Locations.txt` и `Sensors.txt` должны быть сохранены в кодировке **Windows-1251**. Откройте их в продвинутом текстовом редакторе (например, Notepad++) и убедитесь, что кодировка верна.

*   **Проблема** - приложение не видит COM-порты в диалоге загрузки по UART.
    *   **Решение** - убедитесь, что устройство подключено к ПК и драйверы для вашего USB-to-serial адаптера установлены правильно. Нажмите кнопку "Обновить" в диалоге.

*   **Проблема** - приложение падает при запуске или не загружает данные.
    *   **Решение** - возможно, файл `data.json` в папке со сборкой поврежден. Попробуйте удалить или переименовать его. При следующем запуске приложение создаст пустой `data.json`.
```
